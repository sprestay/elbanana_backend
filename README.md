# elbanana_backend
Бэкэнд firebase functions для проекта elbanana. 
Есть рекурсивные асинхронные функции


В bubble есть live и dev версии. 
Каждая функция, вызываемая из bubble должна содержать Referer = "yes" / "no" в header.
    Referer = yes -> live версия
    Referer = no -> dev версия

Для live и dev создаются отдельные коллекции, чтобы обеспечить сохранность данных при тестировании. 

Документация по bubble api - https://manual.bubble.io/core-resources/api/data-api
Так же надо убедиться, что у запрашиваемых данных (коллекции в bubble) в разделе privacy разрешен доступ к api

В firebase хранятся 2 коллекции - filter и candidates
Некоторые поля в коллекции - ссылка на другие коллекции в bubble. Поэтому получение данных из bubble рекурсивно. Есть config_candidate и  config_filter - эти js-объяекты устанавливают соответствие между "названием ссылки с полученном bubble объекте": "endpoint для получения этих данных из bubble БД"

Короче говоря получение данных из БД bubble рекурсивное. Получаем запись из bubble -> парсим в JSON -> если есть значения, указанные в config_candidate / config_filter  -> снова делаем запрос -> снова парсим в js и тд.   
За это отвечают функции buildJsonObject и getSubItem


Функции:
    getAllDatabase - получение всех кандидатов из БД в bubble
        учитываются GET-параметры limit (количество записей) и cursor (offset с которого начать поиск)
        Для каждого кандидата проводим весь цикл получения данных, и сохраняем в БД firebase.
        Настоятельно рекомендую пользоваться limit - запрос зависнет по timeout из-за большого количества данных. 

    addNewCandidate - вызывается при создании кандидата в bubble, передается id нового        пользователя. Так же используется при изменении данных кандидата в БД bubble

    getFilteredCandidates - получаем id фильтра из БД bubble. Снова собираем объект, используя buildJsonObject и getSubItem. Получаем всех кандидатов, сохраненных в БД firebase. К каждому применяем filterFunction, которая проверяет соответсвие переданного кандидата фильтру.  
    Функция возвращает список id отфильтрованных кандидатов. По id будут получаться данные на стороне bubble

    saveFilterToDB - сохраняем фильтр в БД. Это раздел "Create Alert" в bubble. По сохраненным фильтрам будут идти уведомления. 

    filterAlert - тригер при добавлении нового пользователя в БД. Новый кандидат сопоставляется со списком сохраненных фильтров. Оправляем в bubble через webhook id найденных фильтров. На стороне bubble, Backend Workflow получает id фильтра и отправляет email рекрутеру, который сохранил фильтр.